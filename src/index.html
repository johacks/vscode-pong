<html>

<body>
    <div>Our canvas:</div>
    <div id="canvas-div">
        <canvas id="canvas"></canvas>
    </div>
    
    <script>
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const vscode = acquireVsCodeApi();
        let addedKeydownListener = false;
        let addedKeyUpListener = false;
        context.fillStyle = '--vscode-editor-foreground';
        context.strokeStyle = '--vscode-editor-foreground';
        context.globalAlpha = 1;

        function setCanvasDimensions({ width, height }) {
            document.getElementById('canvas-div').style.width = width + 'px';
            document.getElementById('canvas-div').style.height = height + 'px';
            canvas.width = width;
            canvas.height = height;
        }

        function setCanvasStyle(styles) {
            Object.entries(styles).forEach(([key, value]) => {
                if (value !== undefined && value !== null) {
                    (canvas.style)[key] = value;
                }
            });
        }

        function fillRect({ x, y, width, height }) {
            context.fillRect(x, y, width, height);
        }
        function clearRect({ x, y, width, height }) {
            context.clearRect(x, y, width, height);
        }

        function fillDashedLine({ xFrom, yFrom, xTo, yTo, segments }) {
            context.beginPath();
            context.setLineDash(segments);
            context.moveTo(xFrom, yFrom);
            context.lineTo(xTo, yTo);
            context.stroke();
            context.closePath();
        }

        function addKeydownListener() {
            if (addedKeydownListener) {
                return;
            }
            window.addEventListener('keydown', function (event) {  
                console.log('keydown', event.key);
                vscode.postMessage({ command: 'keydown', args: { key: event.key } }, '*');
            });
        }

        function addKeyUpListener() {
            if (addedKeydownListener) {
                return;
            }
            window.addEventListener('keyup', function (event) {  
                console.log('keyup', event.key);
                vscode.postMessage({ command: 'keyup', args: { key: event.key } }, '*');
            });
        }

        function handleMessage(message) {
            const args = message.args;
            switch (message.command) {
                case 'messageQueue': { for (const m of args) { handleMessage(m); } break; }
                case 'setCanvasDimensions': { setCanvasDimensions(args); break; }
                case 'setCanvasStyle': { setCanvasStyle(args); break; }
                case 'fillRect': { fillRect(args); break; }
                case 'clearRect': { clearRect(args); break; }
                case 'fillDashedLine': { fillDashedLine(args); break; }
                case 'addKeyDownListener': { addKeydownListener(); break; }
                case 'addKeyUpListener': { addKeyUpListener(); break; }
            }
        }

        window.addEventListener('message', (event) => {
            const message = event.data;
            handleMessage(message);
        });
        
        // Tell the parent window that we are ready
        vscode.postMessage({ command: 'ready' }, '*');
    </script>
</body>

</html>