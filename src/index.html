<html>
<head>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        #canvas-div {
            position: relative;
            text-align: center;
        }
        #score-left,#score-right {
            width: 50%;
            position: absolute;
            margin-bottom: 10px;
            font-size: 42px;
            font-weight: bold;
            font-family: Arial, sans-serif;
            color: var(--vscode-editor-foreground);
            padding-top: 120px;
        }
        #score-left {
            text-align: right;
            padding-right: 60px;
        }
        #score-right {
            text-align: left;
            padding-left: 60px;
        }
        #score-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>
    <div id="canvas-div">
        <div id="score-container">
            <div id="score-left" class="score">0</div>
            <div id="score-right" class="score">0</div>
        </div>
        <canvas id="canvas"></canvas>
    </div>
</body>

<script>
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    const vscode = acquireVsCodeApi();
    let addedKeydownListener = false;
    let addedKeyUpListener = false;
    let leftPlayerScore = 0;
    let rightPlayerScore = 0;
    const scoreLeftDisplay = document.getElementById('score-left');
    const scoreRightDisplay = document.getElementById('score-right');
    context.fillStyle = '--vscode-editor-foreground';
    context.strokeStyle = '--vscode-editor-foreground';
    context.globalAlpha = 1;

    function setCanvasDimensions({ width, height }) {
        document.getElementById('canvas-div').style.width = width + 'px';
        document.getElementById('canvas-div').style.height = height + 'px';
        canvas.width = width;
        canvas.height = height;
    }

    function setCanvasStyle(styles) {
        Object.entries(styles).forEach(([key, value]) => {
            if (value !== undefined && value !== null) {
                (canvas.style)[key] = value;
            }
        });
    }

    function fillRect({ x, y, width, height }) {
        context.fillRect(x, y, width, height);
    }
    function clearRect({ x, y, width, height }) {
        context.clearRect(x, y, width, height);
    }

    function fillDashedLine({ xFrom, yFrom, xTo, yTo, segments }) {
        context.beginPath();
        context.setLineDash(segments);
        context.moveTo(xFrom, yFrom);
        context.lineTo(xTo, yTo);
        context.stroke();
        context.closePath();
    }

    function addKeydownListener() {
        if (addedKeydownListener) {
            return;
        }
        window.addEventListener('keydown', function (event) {  
            console.log('keydown', event.key);
            vscode.postMessage({ command: 'keydown', args: { key: event.key } }, '*');
        });
    }

    function addKeyUpListener() {
        if (addedKeydownListener) {
            return;
        }
        window.addEventListener('keyup', function (event) {  
            console.log('keyup', event.key);
            vscode.postMessage({ command: 'keyup', args: { key: event.key } }, '*');
        });
    }

    function setLeftPlayerScore(score) {
        leftPlayerScore = score;
        scoreLeftDisplay.innerText = score;
    }

    function setRightPlayerScore(score) {
        rightPlayerScore = score;
        scoreRightDisplay.innerText = score;
    }

    function handleMessage(message) {
        const args = message.args;
        switch (message.command) {
            case 'messageQueue': { for (const m of args) { handleMessage(m); } break; }
            case 'setCanvasDimensions': { setCanvasDimensions(args); break; }
            case 'setCanvasStyle': { setCanvasStyle(args); break; }
            case 'fillRect': { fillRect(args); break; }
            case 'clearRect': { clearRect(args); break; }
            case 'fillDashedLine': { fillDashedLine(args); break; }
            case 'addKeyDownListener': { addKeydownListener(); break; }
            case 'addKeyUpListener': { addKeyUpListener(); break; }
            case 'setLeftPlayerScore': { setLeftPlayerScore(args); break; }
            case 'setRightPlayerScore': { setRightPlayerScore(args); break; }
        }
    }

    window.addEventListener('message', (event) => {
        const message = event.data;
        handleMessage(message);
    });
    
    // Tell the parent window that we are ready
    vscode.postMessage({ command: 'ready' }, '*');
</script>

</html>